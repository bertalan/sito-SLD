{% extends "base.html" %}
{% load wagtailcore_tags wagtailimages_tags wagtailsettings_tags %}
{% get_settings %}

{% block meta_description %}<meta name="description" content="{% if page.subtitle %}{{ page.subtitle }}{% elif page.search_description %}{{ page.search_description }}{% else %}{{ page.title }}{% endif %}">{% endblock %}

{% block og_meta %}{% if page.cover_image %}{% image page.cover_image fill-1200x630 as og_image %}{% elif settings.sld_project.SiteSettings.default_social_image %}{% image settings.sld_project.SiteSettings.default_social_image fill-1200x630 as og_image %}{% endif %}
<meta property="og:type" content="article">
<meta property="og:url" content="{{ request.build_absolute_uri }}">
<meta property="og:title" content="{{ page.title }}">
<meta property="og:description" content="{% if page.subtitle %}{{ page.subtitle }}{% elif page.search_description %}{{ page.search_description }}{% else %}{{ page.title }}{% endif %}">{% if og_image %}
<meta property="og:image" content="{{ request.scheme }}://{{ request.get_host }}{{ og_image.url }}">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">{% endif %}
<meta property="og:locale" content="it_IT">
<meta property="og:site_name" content="{{ settings.sld_project.SiteSettings.studio_name }}">
<meta property="article:published_time" content="{{ page.first_published_at|date:'c' }}">
<meta property="article:modified_time" content="{{ page.last_published_at|date:'c' }}">
<meta property="article:author" content="{% if page.owner and page.owner.get_full_name %}{{ page.owner.get_full_name }}{% else %}{{ settings.sld_project.SiteSettings.lawyer_name }}{% endif %}">{% if page.category %}
<meta property="article:section" content="{{ page.category.name }}">{% endif %}
{% endblock %}

{% block twitter_meta %}{% if page.cover_image %}{% image page.cover_image fill-1200x630 as tw_image %}{% elif settings.sld_project.SiteSettings.default_social_image %}{% image settings.sld_project.SiteSettings.default_social_image fill-1200x630 as tw_image %}{% endif %}
<meta name="twitter:card" content="{% if tw_image %}summary_large_image{% else %}summary{% endif %}">
<meta name="twitter:url" content="{{ request.build_absolute_uri }}">
<meta name="twitter:title" content="{{ page.title }}">
<meta name="twitter:description" content="{% if page.subtitle %}{{ page.subtitle }}{% elif page.search_description %}{{ page.search_description }}{% else %}{{ page.title }}{% endif %}">{% if tw_image %}
<meta name="twitter:image" content="{{ request.scheme }}://{{ request.get_host }}{{ tw_image.url }}">{% endif %}{% if settings.sld_project.SiteSettings.x_url %}
<meta name="twitter:site" content="{{ settings.sld_project.SiteSettings.x_url }}">{% endif %}
{% endblock %}

{% block author_meta %}<meta name="author" content="{% if page.owner and page.owner.get_full_name %}{{ page.owner.get_full_name }}{% else %}{{ settings.sld_project.SiteSettings.lawyer_name }}{% endif %}">{% endblock %}

{% block content %}
{# Header articolo #}
<article>
    <header class="pt-32 pb-12 bg-brand-white border-b border-brand-gray/20">
        <div class="max-w-4xl mx-auto px-6">
            <a href="{{ page.get_parent.url }}" class="text-brand-accent uppercase tracking-widest text-sm mb-6 inline-flex items-center hover:text-brand-black transition-colors">
                <i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i>
                Tutti gli articoli
            </a>
            
            {% if page.category %}
            <div class="mb-4">
                <a href="{{ page.get_parent.url }}?categoria={{ page.category.slug }}" class="inline-block px-3 py-1 bg-brand-accent/10 text-brand-accent text-xs uppercase tracking-widest font-semibold hover:bg-brand-accent hover:text-white transition-colors">
                    <i data-lucide="{{ page.category.icon }}" class="w-3 h-3 inline mr-1"></i>
                    {{ page.category.name }}
                </a>
            </div>
            {% endif %}
            
            <h1 class="text-4xl md:text-5xl lg:text-6xl font-bold tracking-tighter text-brand-black mb-4">
                {{ page.title }}<span class="text-brand-accent">,</span>
            </h1>
            
            {% if page.subtitle %}
            <p class="text-xl text-brand-gray max-w-2xl">{{ page.subtitle }}</p>
            {% endif %}
            
            <div class="flex items-center gap-6 mt-6 text-sm text-brand-gray">
                {% if page.first_published_at %}
                <time datetime="{{ page.first_published_at|date:'Y-m-d' }}" class="flex items-center">
                    <i data-lucide="calendar" class="w-4 h-4 mr-2"></i>
                    {{ page.first_published_at|date:"d F Y" }}
                </time>
                {% endif %}
                <span class="flex items-center">
                    <i data-lucide="clock" class="w-4 h-4 mr-2"></i>
                    {{ page.reading_time }} min di lettura
                </span>
            </div>
        </div>
    </header>
    
    {# Immagine copertina #}
    {% if page.cover_image %}
    <div class="max-w-4xl mx-auto px-6 mt-12 -mb-8">
        <div class="aspect-video overflow-hidden border border-brand-gray/20">
            {% image page.cover_image fill-1200x675 as cover %}
            <img src="{{ cover.url }}" alt="{% if page.cover_image.description %}{{ page.cover_image.description }}{% else %}{{ page.title }}{% endif %}" class="w-full h-full object-cover">
        </div>
    </div>
    {% endif %}
    
    {# Contenuto #}
    <section class="py-16 bg-brand-white">
        <div class="max-w-4xl mx-auto px-6">
            <div class="prose prose-lg prose-gray max-w-none">
                {{ page.body|richtext }}
            </div>
        </div>
    </section>
    
    {# Aree di attività collegate #}
    {% if page.service_areas.all %}
    <section class="py-12 bg-brand-silver border-y border-brand-gray/20">
        <div class="max-w-4xl mx-auto px-6">
            <h3 class="text-sm uppercase tracking-widest text-brand-gray mb-4">Aree di attività correlate</h3>
            <div class="flex flex-wrap gap-3">
                {% for area in page.service_areas.all %}
                {% with area.get_page as area_page %}
                {% if area_page %}
                <a href="{% pageurl area_page %}" class="px-4 py-2 bg-white border border-brand-gray/20 text-brand-black text-sm font-medium hover:border-brand-accent hover:text-brand-accent transition-colors">
                    {{ area.name }}
                </a>
                {% else %}
                <span class="px-4 py-2 bg-white border border-brand-gray/20 text-brand-black text-sm font-medium">
                    {{ area.name }}
                </span>
                {% endif %}
                {% endwith %}
                {% endfor %}
            </div>
        </div>
    </section>
    {% endif %}
    
    {# Articoli correlati #}
    {% if related_articles %}
    <section class="py-16 bg-brand-white border-t border-brand-gray/20">
        <div class="max-w-4xl mx-auto px-6">
            <h3 class="text-2xl font-bold text-brand-black mb-8">Articoli correlati</h3>
            <div class="grid md:grid-cols-3 gap-6">
                {% for article in related_articles %}
                <article class="group border border-brand-gray/20 p-4 hover:border-brand-accent transition-colors">
                    {% if article.category %}
                    <span class="text-xs uppercase tracking-widest text-brand-accent font-semibold">
                        {{ article.category.name }}
                    </span>
                    {% endif %}
                    <h4 class="text-lg font-bold text-brand-black mt-2 group-hover:text-brand-accent transition-colors">
                        <a href="{% pageurl article %}">{{ article.title }}</a>
                    </h4>
                    <span class="text-xs text-brand-gray mt-2 block">
                        <i data-lucide="clock" class="w-3 h-3 inline mr-1"></i>
                        {{ article.reading_time }} min
                    </span>
                </article>
                {% endfor %}
            </div>
        </div>
    </section>
    {% endif %}
</article>

{# CTA #}
<section class="py-16 bg-brand-silver">
    <div class="max-w-4xl mx-auto px-6 text-center">
        <h3 class="text-2xl font-bold text-brand-black mb-4">Hai bisogno di assistenza legale?</h3>
        <p class="text-brand-gray mb-8">Prenota una consulenza per discutere del tuo caso specifico.</p>
        <a href="/prenota/" class="inline-block bg-brand-accent text-white font-bold uppercase tracking-widest px-8 py-4 hover:bg-brand-black transition-colors">
            Prenota appuntamento
        </a>
    </div>
</section>

{# Schema.org JSON-LD - LegalService separato + Article #}
{% if settings.sld_project.SiteSettings.logo %}
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"LegalService","name":"{{ settings.sld_project.SiteSettings.studio_name }}","url":"{{ request.scheme }}://{{ request.get_host }}/","logo":"{{ request.scheme }}://{{ request.get_host }}{{ settings.sld_project.SiteSettings.logo.file.url }}","telephone":"{{ settings.sld_project.SiteSettings.phone }}","email":"{{ settings.sld_project.SiteSettings.email }}","address":{"@type":"PostalAddress","streetAddress":"{{ settings.sld_project.SiteSettings.address }}","addressLocality":"{{ settings.sld_project.SiteSettings.city }}","addressCountry":"IT"},"priceRange":"€€"}
</script>
{% endif %}
{% if page.cover_image %}{% image page.cover_image fill-1200x630 as jsonld_img %}{% elif settings.sld_project.SiteSettings.default_social_image %}{% image settings.sld_project.SiteSettings.default_social_image fill-1200x630 as jsonld_img %}{% endif %}
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"Article","headline":"{{ page.title }}","description":"{% if page.subtitle %}{{ page.subtitle }}{% elif page.search_description %}{{ page.search_description }}{% else %}{{ page.title }}{% endif %}"{% if jsonld_img %},"image":"{{ request.scheme }}://{{ request.get_host }}{{ jsonld_img.url }}"{% endif %},"datePublished":"{{ page.first_published_at|date:'c' }}","dateModified":"{% if page.last_published_at %}{{ page.last_published_at|date:'c' }}{% else %}{{ page.first_published_at|date:'c' }}{% endif %}","author":{"@type":"Person","name":"{% if page.owner and page.owner.get_full_name %}{{ page.owner.get_full_name }}{% else %}{{ settings.sld_project.SiteSettings.lawyer_name }}{% endif %}"},"publisher":{"@type":"Organization","name":"{{ settings.sld_project.SiteSettings.studio_name }}"{% if settings.sld_project.SiteSettings.logo %},"logo":{"@type":"ImageObject","url":"{{ request.scheme }}://{{ request.get_host }}{{ settings.sld_project.SiteSettings.logo.file.url }}"}{% endif %}},"mainEntityOfPage":{"@type":"WebPage","@id":"{{ request.build_absolute_uri }}"}}
</script>
{% endblock %}
