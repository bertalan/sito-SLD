{% extends "base.html" %}
{% load wagtailcore_tags %}

{% block content %}
{% if is_demo_mode %}
<!-- Banner modalità demo -->
<div class="fixed top-0 left-0 right-0 z-50 bg-yellow-400 text-yellow-900 text-center py-2 text-sm font-bold uppercase tracking-wider">
    <i data-lucide="alert-triangle" class="inline w-4 h-4 mr-2"></i>
    Modalità Demo - I pagamenti sono simulati
</div>
{% endif %}

<section class="pt-32 pb-12 bg-brand-white border-b border-brand-gray/20">
    <div class="max-w-4xl mx-auto px-6">
        <h1 class="text-5xl md:text-7xl font-bold tracking-tighter text-brand-black mb-4">
            PRENOTA<span class="text-brand-accent">,</span>
        </h1>
        <p class="text-brand-gray text-lg">
            Prenota una consulenza in presenza o in videochiamata.<br>
            Costo: <strong class="text-brand-accent">€{{ booking_price }}</strong> per {{ slot_duration }} minuti
        </p>
    </div>
</section>

<section class="py-16 bg-brand-white">
    <div class="max-w-4xl mx-auto px-6">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
            <!-- Calendario con orari -->
            <div>
                <h2 class="text-xl font-bold text-brand-black mb-6 uppercase tracking-wider">
                    <i data-lucide="calendar" class="inline w-5 h-5 text-brand-accent mr-2"></i>
                    Seleziona data e orario
                </h2>
                <div id="calendar" class="bg-brand-silver p-6 rounded"></div>
                
                <div id="slots-container" class="mt-6">
                    <h3 class="text-lg font-bold text-brand-black mb-4">Orari disponibili</h3>
                    <div id="slots" class="grid grid-cols-4 gap-2">
                        <p class="col-span-4 text-brand-gray text-sm">Seleziona una data per vedere gli orari</p>
                    </div>
                </div>
                
                <!-- Selettore durata -->
                <div id="duration-container" class="mt-6 hidden">
                    <h3 class="text-lg font-bold text-brand-black mb-4">Durata consulenza</h3>
                    <div class="grid grid-cols-{{ max_slots }} gap-2">
                        {% for i in "1234"|make_list %}
                        {% if forloop.counter <= max_slots %}
                        <button type="button" onclick="selectDuration({{ forloop.counter }})"
                            class="p-3 text-sm border-2 border-brand-gray/30 hover:bg-brand-accent hover:text-white hover:border-brand-accent transition-colors duration-btn{% if forloop.counter == 1 %} bg-brand-accent text-white border-brand-accent{% endif %}"
                            data-slots="{{ forloop.counter }}">
                            <span class="block font-bold">{{ forloop.counter }}x{{ slot_duration }}min</span>
                            <span class="text-xs opacity-75" data-price="{{ forloop.counter }}"></span>
                        </button>
                        {% endif %}
                        {% endfor %}
                    </div>
                    <p id="duration-warning" class="text-amber-600 text-xs mt-2 hidden">
                        <i data-lucide="alert-triangle" class="inline w-3 h-3 mr-1"></i>
                        <span></span>
                    </p>
                </div>
            </div>
            
            <!-- Form -->
            <div>
                <h2 class="text-xl font-bold text-brand-black mb-6 uppercase tracking-wider">
                    <i data-lucide="user" class="inline w-5 h-5 text-brand-accent mr-2"></i>
                    I tuoi dati
                </h2>
                <form id="booking-form" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs uppercase tracking-widest text-brand-gray mb-2">Nome *</label>
                            <input type="text" name="first_name" required
                                class="w-full border border-brand-gray/30 px-4 py-3 focus:outline-none focus:border-brand-accent">
                        </div>
                        <div>
                            <label class="block text-xs uppercase tracking-widest text-brand-gray mb-2">Cognome *</label>
                            <input type="text" name="last_name" required
                                class="w-full border border-brand-gray/30 px-4 py-3 focus:outline-none focus:border-brand-accent">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs uppercase tracking-widest text-brand-gray mb-2">Email *</label>
                        <input type="email" name="email" required
                            class="w-full border border-brand-gray/30 px-4 py-3 focus:outline-none focus:border-brand-accent">
                    </div>
                    <div>
                        <label class="block text-xs uppercase tracking-widest text-brand-gray mb-2">Telefono *</label>
                        <input type="tel" name="phone" required
                            class="w-full border border-brand-gray/30 px-4 py-3 focus:outline-none focus:border-brand-accent">
                    </div>
                    
                    <!-- Riepilogo appuntamento selezionato -->
                    <div id="selection-summary" class="bg-brand-silver p-4 hidden">
                        <p class="text-sm text-brand-gray">Appuntamento selezionato:</p>
                        <p class="font-bold text-brand-black" id="summary-text"></p>
                    </div>
                    
                    <!-- Tipo consulenza -->
                    <div>
                        <label class="block text-xs uppercase tracking-widest text-brand-gray mb-4">Modalità consulenza *</label>
                        <div class="grid grid-cols-2 gap-4">
                            <label class="cursor-pointer">
                                <input type="radio" name="consultation_type" value="in_person" required class="sr-only peer">
                                <div class="border-2 border-brand-gray/30 p-4 text-center peer-checked:border-brand-accent peer-checked:bg-brand-accent/10 transition-all">
                                    <i data-lucide="building-2" class="w-6 h-6 mx-auto mb-2 text-brand-gray"></i>
                                    <span class="block font-bold text-sm">In presenza</span>
                                    <span class="text-xs text-brand-gray">Presso lo studio a Lecce</span>
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="consultation_type" value="video" checked class="sr-only peer">
                                <div class="border-2 border-brand-gray/30 p-4 text-center peer-checked:border-brand-accent peer-checked:bg-brand-accent/10 transition-all">
                                    <i data-lucide="video" class="w-6 h-6 mx-auto mb-2 text-brand-gray"></i>
                                    <span class="block font-bold text-sm">Videochiamata</span>
                                    <span class="text-xs text-brand-gray">Collegamento Jitsi</span>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-xs uppercase tracking-widest text-brand-gray mb-2">Note *</label>
                        <textarea name="notes" rows="3" required
                            class="w-full border border-brand-gray/30 px-4 py-3 focus:outline-none focus:border-brand-accent"
                            placeholder="Descrivi brevemente il motivo della consulenza..."></textarea>
                    </div>
                    
                    <!-- Upload allegati -->
                    <div>
                        <label class="block text-xs uppercase tracking-widest text-brand-gray mb-2">Allegati (opzionale)</label>
                        <div class="border-2 border-dashed border-brand-gray/30 p-4 text-center hover:border-brand-accent transition-colors cursor-pointer relative"
                             onclick="document.getElementById('file-input').click()">
                            <input type="file" id="file-input" name="attachments" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"
                                   class="hidden" onchange="handleFileSelect(this)">
                            <i data-lucide="paperclip" class="w-6 h-6 mx-auto mb-2 text-brand-gray"></i>
                            <p class="text-sm text-brand-gray">Clicca o trascina i file qui</p>
                            <p class="text-xs text-brand-gray/60 mt-1">PDF, DOC, DOCX, JPG, PNG (max 20MB totali)</p>
                        </div>
                        <div id="file-list" class="mt-2 space-y-1"></div>
                        <p id="file-error" class="text-red-500 text-xs mt-1 hidden"></p>
                    </div>
                    
                    <input type="hidden" name="date" id="selected-date">
                    <input type="hidden" name="time" id="selected-time">
                    <input type="hidden" name="slot_count" id="selected-slot-count" value="1">
                    
                    <!-- Scelta metodo di pagamento -->
                    <div class="mt-6">
                        <label class="block text-xs uppercase tracking-widest text-brand-gray mb-4">Metodo di pagamento *</label>
                        <div class="grid grid-cols-2 gap-4">
                            <label class="payment-option cursor-pointer">
                                <input type="radio" name="payment_method" value="stripe" required class="sr-only peer">
                                <div class="border-2 border-brand-gray/30 p-4 text-center peer-checked:border-brand-accent peer-checked:bg-brand-accent/10 transition-all">
                                    <i data-lucide="credit-card" class="w-8 h-8 mx-auto mb-2 text-brand-gray peer-checked:text-brand-accent"></i>
                                    <span class="block font-bold text-sm">Carta di credito</span>
                                    <span class="text-xs text-brand-gray">Visa, Mastercard, Amex</span>
                                </div>
                            </label>
                            <label class="payment-option cursor-pointer">
                                <input type="radio" name="payment_method" value="paypal" checked class="sr-only peer">
                                <div class="border-2 border-brand-gray/30 p-4 text-center peer-checked:border-brand-accent peer-checked:bg-brand-accent/10 transition-all">
                                    <svg class="w-8 h-8 mx-auto mb-2" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M7.076 21.337H2.47a.641.641 0 0 1-.633-.74L4.944 3.72a.773.773 0 0 1 .76-.65h6.98c2.315 0 4.1.67 5.145 1.935.964 1.168 1.31 2.725.998 4.502-.038.22-.081.428-.133.634-.576 2.874-2.477 4.888-5.54 5.85-.644.204-1.335.333-2.067.396-.135.012-.273.02-.412.024h-1.45a.769.769 0 0 0-.76.65l-.934 5.628a.641.641 0 0 1-.633.548h.178z" fill="#003087"/>
                                        <path d="M19.35 6.645c-.576 2.874-2.477 4.888-5.54 5.85-.644.204-1.335.333-2.067.396-.135.012-.273.02-.412.024H9.88a.769.769 0 0 0-.76.65L8.187 19.2l-.52 3.134a.538.538 0 0 0 .531.627h3.83a.674.674 0 0 0 .665-.569l.66-4.184a.769.769 0 0 1 .76-.65h.48c3.503 0 6.257-1.42 7.085-5.526.339-1.682.154-3.054-.587-4.003a3.893 3.893 0 0 0-1.16-.934 5.56 5.56 0 0 1 0 0l-.001-.45z" fill="#0070E0"/>
                                    </svg>
                                    <span class="block font-bold text-sm">PayPal</span>
                                    <span class="text-xs text-brand-gray">Paga con il tuo conto</span>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <button type="submit" id="submit-btn" disabled
                        class="w-full bg-brand-accent text-white font-bold uppercase tracking-widest px-8 py-4 hover:bg-brand-black transition-colors disabled:opacity-50 disabled:cursor-not-allowed mt-6">
                        <span id="btn-text">Procedi al pagamento - €{{ booking_price }}</span>
                    </button>
                </form>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
const availableDates = {{ available_dates|safe }};
let selectedDate = null;
let selectedTime = null;
let selectedSlotCount = 1;
let selectedFiles = [];
let currentSlots = []; // Slot disponibili per la data corrente
const MAX_FILE_SIZE = 20 * 1024 * 1024; // 20MB

// Configurazione prezzi e slot (da Django)
const SLOT_DURATION = {{ slot_duration }};
const PRICE_CENTS = {{ booking_price_cents }};
const MAX_SLOTS = {{ max_slots }};

function formatPrice(cents) {
    return (cents / 100).toFixed(2).replace('.', ',');
}

function updatePriceDisplay() {
    const totalCents = selectedSlotCount * PRICE_CENTS;
    const priceStr = formatPrice(totalCents);
    const durationMins = selectedSlotCount * SLOT_DURATION;
    
    // Aggiorna bottone
    document.getElementById('btn-text').textContent = `Procedi al pagamento - €${priceStr}`;
    
    // Aggiorna prezzi nei bottoni durata
    document.querySelectorAll('.duration-btn').forEach(btn => {
        const slots = parseInt(btn.dataset.slots);
        const price = formatPrice(slots * PRICE_CENTS);
        btn.querySelector('[data-price]').textContent = `€${price}`;
    });
}

document.addEventListener('DOMContentLoaded', function() {
    lucide.createIcons();
    
    // Inizializza i prezzi nei bottoni durata
    updatePriceDisplay();
    
    // Se oggi è l'ultimo giorno del mese o non ci sono date disponibili questo mese, mostra il prossimo
    const today = new Date();
    const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
    const hasAvailableThisMonth = availableDates.some(d => {
        const date = new Date(d);
        return date.getMonth() === today.getMonth() && date > today;
    });
    
    renderCalendar(hasAvailableThisMonth ? 0 : 1);
    
    document.getElementById('booking-form').addEventListener('submit', handleSubmit);
    
    // Drag and drop per i file
    const dropZone = document.querySelector('[onclick*="file-input"]');
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('border-brand-accent', 'bg-brand-accent/5');
    });
    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('border-brand-accent', 'bg-brand-accent/5');
    });
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('border-brand-accent', 'bg-brand-accent/5');
        handleFileSelect({ files: e.dataTransfer.files });
    });
});

function handleFileSelect(input) {
    const files = Array.from(input.files || []);
    const errorEl = document.getElementById('file-error');
    errorEl.classList.add('hidden');
    
    // Calcola dimensione totale
    let totalSize = selectedFiles.reduce((acc, f) => acc + f.size, 0);
    
    for (const file of files) {
        totalSize += file.size;
        if (totalSize > MAX_FILE_SIZE) {
            errorEl.textContent = 'La dimensione totale degli allegati supera i 20MB';
            errorEl.classList.remove('hidden');
            return;
        }
        selectedFiles.push(file);
    }
    
    renderFileList();
}

function removeFile(index) {
    selectedFiles.splice(index, 1);
    renderFileList();
    document.getElementById('file-error').classList.add('hidden');
}

function renderFileList() {
    const listEl = document.getElementById('file-list');
    if (selectedFiles.length === 0) {
        listEl.innerHTML = '';
        return;
    }
    
    listEl.innerHTML = selectedFiles.map((file, i) => `
        <div class="flex items-center justify-between bg-brand-silver px-3 py-2 text-sm">
            <span class="text-brand-black truncate mr-2">${file.name}</span>
            <button type="button" onclick="removeFile(${i})" class="text-brand-gray hover:text-red-500">
                <i data-lucide="x" class="w-4 h-4"></i>
            </button>
        </div>
    `).join('');
    lucide.createIcons();
}

function renderCalendar(monthOffset = 0) {
    const calendar = document.getElementById('calendar');
    const today = new Date();
    
    // Calcola il mese da mostrare
    let displayDate = new Date(today.getFullYear(), today.getMonth() + monthOffset, 1);
    const currentMonth = displayDate.getMonth();
    const currentYear = displayDate.getFullYear();
    
    // Salva l'offset corrente per la navigazione
    calendar.dataset.monthOffset = monthOffset;
    
    let html = `
        <div class="flex items-center justify-between mb-4">
            <button type="button" onclick="renderCalendar(${monthOffset - 1})" class="p-2 hover:bg-brand-accent hover:text-white rounded transition-colors ${monthOffset <= 0 ? 'invisible' : ''}">
                <i data-lucide="chevron-left" class="w-5 h-5"></i>
            </button>
            <span class="font-bold text-brand-black capitalize">${displayDate.toLocaleDateString('it-IT', { month: 'long', year: 'numeric' })}</span>
            <button type="button" onclick="renderCalendar(${monthOffset + 1})" class="p-2 hover:bg-brand-accent hover:text-white rounded transition-colors ${monthOffset >= 2 ? 'invisible' : ''}">
                <i data-lucide="chevron-right" class="w-5 h-5"></i>
            </button>
        </div>
        <div class="grid grid-cols-7 gap-1 text-center text-xs text-brand-gray mb-2">
            <span>Lun</span><span>Mar</span><span>Mer</span><span>Gio</span><span>Ven</span><span>Sab</span><span>Dom</span>
        </div>
        <div class="grid grid-cols-7 gap-1">
    `;
    
    const firstDay = new Date(currentYear, currentMonth, 1).getDay();
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
    const startDay = firstDay === 0 ? 6 : firstDay - 1;
    
    for (let i = 0; i < startDay; i++) {
        html += '<span></span>';
    }
    
    for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const isAvailable = availableDates.includes(dateStr);
        const checkDate = new Date(currentYear, currentMonth, day);
        const isPast = checkDate <= today;
        
        if (isAvailable && !isPast) {
            html += `<button type="button" onclick="selectDate('${dateStr}')" 
                class="p-2 text-sm font-medium hover:bg-brand-accent hover:text-white transition-colors rounded date-btn"
                data-date="${dateStr}">${day}</button>`;
        } else {
            html += `<span class="p-2 text-sm text-brand-gray/40">${day}</span>`;
        }
    }
    
    html += '</div>';
    calendar.innerHTML = html;
    lucide.createIcons();
}

function selectDate(dateStr) {
    selectedDate = dateStr;
    selectedTime = null;
    selectedSlotCount = 1;
    document.getElementById('selected-date').value = dateStr;
    document.getElementById('selected-time').value = '';
    document.getElementById('selected-slot-count').value = '1';
    
    // Reset durata
    document.querySelectorAll('.duration-btn').forEach(btn => {
        btn.classList.remove('bg-brand-accent', 'text-white', 'border-brand-accent');
        if (btn.dataset.slots === '1') {
            btn.classList.add('bg-brand-accent', 'text-white', 'border-brand-accent');
        }
    });
    
    // Nascondi summary e disabilita submit
    document.getElementById('selection-summary').classList.add('hidden');
    document.getElementById('submit-btn').disabled = true;
    document.getElementById('duration-container').classList.add('hidden');
    
    // Evidenzia data selezionata
    document.querySelectorAll('.date-btn').forEach(btn => {
        btn.classList.remove('bg-brand-accent', 'text-white');
    });
    document.querySelector(`[data-date="${dateStr}"]`).classList.add('bg-brand-accent', 'text-white');
    
    // Carica slots
    fetch(`/prenota/slots/${dateStr}/`)
        .then(r => r.json())
        .then(data => {
            const container = document.getElementById('slots-container');
            const slots = document.getElementById('slots');
            
            if (data.slots && data.slots.length > 0) {
                currentSlots = data.slots; // Salva per calcolo slot consecutivi
                slots.innerHTML = data.slots.map(time => `
                    <button type="button" onclick="selectTime('${time}')"
                        class="p-2 text-sm border border-brand-gray/30 hover:bg-brand-accent hover:text-white hover:border-brand-accent transition-colors time-btn"
                        data-time="${time}">${time}</button>
                `).join('');
                container.classList.remove('hidden');
            } else {
                currentSlots = [];
                slots.innerHTML = '<p class="col-span-4 text-brand-gray">Nessun orario disponibile</p>';
                container.classList.remove('hidden');
            }
        });
}

function selectTime(time) {
    selectedTime = time;
    selectedSlotCount = 1;
    document.getElementById('selected-time').value = time;
    document.getElementById('selected-slot-count').value = '1';
    
    document.querySelectorAll('.time-btn').forEach(btn => {
        btn.classList.remove('bg-brand-accent', 'text-white', 'border-brand-accent');
    });
    document.querySelector(`[data-time="${time}"]`).classList.add('bg-brand-accent', 'text-white', 'border-brand-accent');
    
    // Mostra selettore durata
    document.getElementById('duration-container').classList.remove('hidden');
    
    // Reset durata a 1
    document.querySelectorAll('.duration-btn').forEach(btn => {
        btn.classList.remove('bg-brand-accent', 'text-white', 'border-brand-accent');
        if (btn.dataset.slots === '1') {
            btn.classList.add('bg-brand-accent', 'text-white', 'border-brand-accent');
        }
    });
    
    // Calcola quanti slot consecutivi sono disponibili
    updateDurationAvailability();
    
    updateSummary();
    document.getElementById('submit-btn').disabled = false;
}

function getConsecutiveSlots(startTime, count) {
    // Converte HH:MM in minuti dal mezzanotte
    const [h, m] = startTime.split(':').map(Number);
    let startMins = h * 60 + m;
    
    const neededSlots = [];
    for (let i = 0; i < count; i++) {
        const hours = Math.floor(startMins / 60);
        const mins = startMins % 60;
        const timeStr = `${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}`;
        neededSlots.push(timeStr);
        startMins += SLOT_DURATION;
    }
    return neededSlots;
}

function updateDurationAvailability() {
    const warningEl = document.getElementById('duration-warning');
    warningEl.classList.add('hidden');
    
    // Per ogni opzione durata, verifica se gli slot sono disponibili
    document.querySelectorAll('.duration-btn').forEach(btn => {
        const slots = parseInt(btn.dataset.slots);
        const neededSlots = getConsecutiveSlots(selectedTime, slots);
        const allAvailable = neededSlots.every(s => currentSlots.includes(s));
        
        if (allAvailable) {
            btn.disabled = false;
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
        } else {
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            // Se era selezionato, deseleziona
            if (selectedSlotCount === slots && slots > 1) {
                selectedSlotCount = 1;
                document.getElementById('selected-slot-count').value = '1';
                selectDuration(1);
            }
        }
    });
}

function selectDuration(slots) {
    // Verifica che gli slot consecutivi siano disponibili
    const neededSlots = getConsecutiveSlots(selectedTime, slots);
    const allAvailable = neededSlots.every(s => currentSlots.includes(s));
    
    if (!allAvailable) {
        const warningEl = document.getElementById('duration-warning');
        warningEl.querySelector('span').textContent = `Non ci sono ${slots} slot consecutivi disponibili da questo orario.`;
        warningEl.classList.remove('hidden');
        return;
    }
    
    document.getElementById('duration-warning').classList.add('hidden');
    selectedSlotCount = slots;
    document.getElementById('selected-slot-count').value = slots;
    
    // Evidenzia bottone selezionato
    document.querySelectorAll('.duration-btn').forEach(btn => {
        btn.classList.remove('bg-brand-accent', 'text-white', 'border-brand-accent');
    });
    document.querySelector(`.duration-btn[data-slots="${slots}"]`).classList.add('bg-brand-accent', 'text-white', 'border-brand-accent');
    
    updateSummary();
    updatePriceDisplay();
    lucide.createIcons();
}

function updateSummary() {
    const summary = document.getElementById('selection-summary');
    const date = new Date(selectedDate);
    const durationMins = selectedSlotCount * SLOT_DURATION;
    
    // Calcola ora fine
    const [h, m] = selectedTime.split(':').map(Number);
    const endMins = h * 60 + m + durationMins;
    const endH = Math.floor(endMins / 60);
    const endM = endMins % 60;
    const endTime = `${String(endH).padStart(2, '0')}:${String(endM).padStart(2, '0')}`;
    
    const priceStr = formatPrice(selectedSlotCount * PRICE_CENTS);
    
    document.getElementById('summary-text').innerHTML = 
        `${date.toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long' })}<br>` +
        `<span class="text-brand-accent">${selectedTime} - ${endTime}</span> (${durationMins} min) - <strong>€${priceStr}</strong>`;
    summary.classList.remove('hidden');
}

async function handleSubmit(e) {
    e.preventDefault();
    
    const form = e.target;
    const paymentMethod = form.querySelector('input[name="payment_method"]:checked').value;
    
    // Verifica dimensione file prima di inviare
    const totalSize = selectedFiles.reduce((acc, f) => acc + f.size, 0);
    if (totalSize > MAX_FILE_SIZE) {
        document.getElementById('file-error').textContent = 'La dimensione totale degli allegati supera i 20MB';
        document.getElementById('file-error').classList.remove('hidden');
        return;
    }
    
    // Usa FormData per inviare anche i file
    const formData = new FormData();
    formData.append('first_name', form.first_name.value);
    formData.append('last_name', form.last_name.value);
    formData.append('email', form.email.value);
    formData.append('phone', form.phone.value);
    formData.append('notes', form.notes.value);
    formData.append('consultation_type', document.querySelector('input[name="consultation_type"]:checked').value);
    formData.append('date', selectedDate);
    formData.append('time', selectedTime);
    formData.append('slot_count', selectedSlotCount);
    formData.append('payment_method', paymentMethod);
    
    selectedFiles.forEach((file, i) => {
        formData.append('attachments', file);
    });
    
    // Calcola prezzo per il messaggio di errore
    const currentPrice = formatPrice(selectedSlotCount * PRICE_CENTS);
    
    // Disabilita il bottone durante l'elaborazione
    const submitBtn = document.getElementById('submit-btn');
    submitBtn.disabled = true;
    document.getElementById('btn-text').textContent = 'Elaborazione in corso...';
    
    try {
        const response = await fetch('/prenota/checkout/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        });
        
        const result = await response.json();
        
        if (result.url) {
            window.location.href = result.url;
        } else {
            alert(result.error || 'Errore durante la prenotazione');
            submitBtn.disabled = false;
            document.getElementById('btn-text').textContent = `Procedi al pagamento - €${currentPrice}`;
        }
    } catch (error) {
        alert('Errore di connessione');
        submitBtn.disabled = false;
        document.getElementById('btn-text').textContent = `Procedi al pagamento - €${currentPrice}`;
    }
}
</script>
{% endblock %}