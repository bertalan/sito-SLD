{% extends "wagtailadmin/base.html" %}
{% load wagtailadmin_tags %}

{% block titletag %}Rimborsa Pagamento{% endblock %}

{% block content %}
    {% include "wagtailadmin/shared/header.html" with title="Rimborsa Pagamento" icon="warning" %}

    <div class="nice-padding">
        <!-- Helper: Come funziona il rimborso -->
        <div class="w-panel">
            <div class="w-panel__header">
                <h2 class="w-panel__heading w-panel__heading--label">
                    <svg class="icon icon-help w-panel__icon" aria-hidden="true"><use href="#icon-help"></use></svg>
                    Come funziona il rimborso
                </h2>
            </div>
            <div class="w-panel__content">
                <ul class="w-help-text" style="margin: 0; padding-left: 1.5rem; line-height: 1.8;">
                    <li><strong>Tempi di accredito:</strong> Il rimborso sarà visibile sul conto del cliente entro <strong>5-10 giorni lavorativi</strong>, a seconda del metodo di pagamento e della banca.</li>
                    <li><strong>Importo:</strong> Verrà rimborsato l'intero importo pagato (€{{ appointment.amount_paid }}).</li>
                    <li><strong>Email:</strong> Il cliente riceverà una notifica automatica via email con i dettagli del rimborso.</li>
                    <li><strong>Azione irreversibile:</strong> Una volta confermato, il rimborso non può essere annullato.</li>
                </ul>
            </div>
        </div>

        <!-- Avviso critico -->
        <div class="w-panel" style="margin-top: 1.5rem;">
            <div class="w-panel__content" style="background: var(--w-color-critical-50); border-left: 4px solid var(--w-color-critical-200);">
                <p style="color: var(--w-color-critical-200); font-weight: 600; margin: 0 0 0.5rem 0;">
                    ⚠️ Attenzione: questa azione non può essere annullata!
                </p>
                <p style="color: var(--w-color-text-context); margin: 0;">
                    Stai per rimborsare il pagamento per l'appuntamento di 
                    <strong>{{ appointment.first_name }} {{ appointment.last_name }}</strong>.
                </p>
            </div>
        </div>

        <!-- Dettagli Appuntamento -->
        <div class="w-panel" style="margin-top: 1.5rem;">
            <div class="w-panel__header">
                <h2 class="w-panel__heading w-panel__heading--label">Dettagli Appuntamento</h2>
            </div>
            <div class="w-panel__content">
                <dl class="w-field__wrapper" style="display: grid; grid-template-columns: 180px 1fr; gap: 0.75rem 1rem; margin: 0;">
                    <dt class="w-field__label">Cliente:</dt>
                    <dd style="margin: 0;">{{ appointment.first_name }} {{ appointment.last_name }}</dd>
                    
                    <dt class="w-field__label">Data:</dt>
                    <dd style="margin: 0;">{{ appointment.date|date:"l d F Y" }}</dd>
                    
                    <dt class="w-field__label">Ora:</dt>
                    <dd style="margin: 0;">{{ appointment.time|time:"H:i" }}</dd>
                    
                    <dt class="w-field__label">Metodo pagamento:</dt>
                    <dd style="margin: 0;">{{ appointment.get_payment_method_display }}</dd>
                    
                    <dt class="w-field__label">Importo pagato:</dt>
                    <dd style="margin: 0; color: var(--w-color-positive-100); font-weight: 600;">€{{ appointment.amount_paid }}</dd>
                    
                    {% if appointment.stripe_payment_intent_id %}
                    <dt class="w-field__label">ID Stripe:</dt>
                    <dd style="margin: 0; font-family: var(--w-font-mono); font-size: 0.875rem;">{{ appointment.stripe_payment_intent_id }}</dd>
                    {% endif %}
                    
                    {% if appointment.paypal_payment_id %}
                    <dt class="w-field__label">ID PayPal:</dt>
                    <dd style="margin: 0; font-family: var(--w-font-mono); font-size: 0.875rem;">{{ appointment.paypal_payment_id }}</dd>
                    {% endif %}
                </dl>
            </div>
        </div>

        <!-- Form conferma -->
        <form method="post" style="margin-top: 1.5rem;">
            {% csrf_token %}
            
            <!-- Captcha matematico -->
            <div class="w-panel">
                <div class="w-panel__header">
                    <h2 class="w-panel__heading w-panel__heading--label">
                        <svg class="icon icon-lock w-panel__icon" aria-hidden="true"><use href="#icon-lock"></use></svg>
                        Verifica di sicurezza
                    </h2>
                </div>
                <div class="w-panel__content" style="background: var(--w-color-warning-50);">
                    <p class="w-help-text" style="margin: 0 0 1rem 0;">
                        Per confermare il rimborso, risolvi questa operazione:
                    </p>
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <span style="font-size: 1.25rem; font-weight: 600;">
                            {{ num1 }} + {{ num2 }} =
                        </span>
                        <input type="hidden" name="expected_result" value="{{ expected_result }}">
                        <input type="number" name="captcha_result" required
                               class="w-field__input"
                               style="width: 80px; text-align: center; font-size: 1.25rem;"
                               placeholder="?">
                    </div>
                </div>
            </div>

            <!-- Pulsanti azione -->
            <footer class="footer" style="margin-top: 1.5rem;">
                <ul>
                    <li class="footer__container">
                        <a href="{% url 'wagtailsnippets_booking_appointment:edit' appointment.pk %}" 
                           class="button button-secondary">
                            Annulla
                        </a>
                    </li>
                    <li class="footer__container">
                        <button type="submit" class="button button--icon no">
                            <svg class="icon icon-cross" aria-hidden="true"><use href="#icon-cross"></use></svg>
                            Conferma Rimborso
                        </button>
                    </li>
                </ul>
            </footer>
        </form>
    </div>
{% endblock %}
