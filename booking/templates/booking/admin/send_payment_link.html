{% extends "wagtailadmin/base.html" %}
{% load wagtailadmin_tags %}

{% block titletag %}Invia Link Pagamento{% endblock %}

{% block content %}
    {% include "wagtailadmin/shared/header.html" with title="Invia Link Pagamento" icon="mail" %}

    <div class="nice-padding">
        <!-- Helper: Come funziona -->
        <div class="w-panel">
            <div class="w-panel__header">
                <h2 class="w-panel__heading w-panel__heading--label">
                    <svg class="icon icon-help w-panel__icon" aria-hidden="true"><use href="#icon-help"></use></svg>
                    Come funziona
                </h2>
            </div>
            <div class="w-panel__content">
                <ul class="w-help-text" style="margin: 0; padding-left: 1.5rem; line-height: 1.8;">
                    <li><strong>Link personalizzato:</strong> Verr√† generato un link unico e sicuro per questo appuntamento.</li>
                    <li><strong>Validit√†:</strong> Il link rimarr√† valido fino a quando l'appuntamento non sar√† pagato o cancellato.</li>
                    <li><strong>Email:</strong> Il cliente ricever√† un'email con il link e le istruzioni per completare il pagamento.</li>
                    <li><strong>Promemoria:</strong> Puoi inviare nuovamente il link se il cliente non ha ricevuto l'email.</li>
                </ul>
            </div>
        </div>

        <!-- Info destinatario -->
        <div class="w-panel" style="margin-top: 1.5rem;">
            <div class="w-panel__content" style="background: var(--w-color-info-50); border-left: 4px solid var(--w-color-info-100);">
                <p style="color: var(--w-color-text-context); margin: 0;">
                    üìß Invieremo un'email a <strong>{{ appointment.email }}</strong> con il link per completare il pagamento.
                </p>
            </div>
        </div>

        <!-- Dettagli Appuntamento -->
        <div class="w-panel" style="margin-top: 1.5rem;">
            <div class="w-panel__header">
                <h2 class="w-panel__heading w-panel__heading--label">Dettagli Appuntamento</h2>
            </div>
            <div class="w-panel__content">
                <dl class="w-field__wrapper" style="display: grid; grid-template-columns: 180px 1fr; gap: 0.75rem 1rem; margin: 0;">
                    <dt class="w-field__label">Cliente:</dt>
                    <dd style="margin: 0;">{{ appointment.first_name }} {{ appointment.last_name }}</dd>
                    
                    <dt class="w-field__label">Data:</dt>
                    <dd style="margin: 0;">{{ appointment.date|date:"l d F Y" }}</dd>
                    
                    <dt class="w-field__label">Ora:</dt>
                    <dd style="margin: 0;">{{ appointment.time|time:"H:i" }}</dd>
                    
                    <dt class="w-field__label">Modalit√†:</dt>
                    <dd style="margin: 0;">{{ appointment.get_consultation_type_display }}</dd>
                    
                    <dt class="w-field__label">Importo:</dt>
                    <dd style="margin: 0; color: var(--w-color-positive-100); font-weight: 600;">‚Ç¨{{ appointment.total_price_display }}</dd>
                </dl>
            </div>
        </div>

        <!-- Form invio -->
        <form method="post" style="margin-top: 1.5rem;">
            {% csrf_token %}
            
            <!-- Metodo di pagamento -->
            <div class="w-panel">
                <div class="w-panel__header">
                    <h2 class="w-panel__heading w-panel__heading--label">Metodo di pagamento</h2>
                </div>
                <div class="w-panel__content">
                    <p class="w-help-text" style="margin: 0 0 1rem 0;">
                        Scegli il metodo di pagamento che verr√† proposto al cliente.
                    </p>
                    <div class="w-field__wrapper" style="display: flex; gap: 1rem;">
                        {% for value, label in payment_methods %}
                        <label class="w-field" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; background: var(--w-color-surface-page); border: 2px solid var(--w-color-border-furniture); border-radius: 0.5rem; cursor: pointer;">
                            <input type="radio" name="payment_method" value="{{ value }}" 
                                   {% if appointment.payment_method == value or forloop.first %}checked{% endif %}>
                            {{ label }}
                        </label>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <!-- Captcha matematico -->
            <div class="w-panel" style="margin-top: 1.5rem;">
                <div class="w-panel__header">
                    <h2 class="w-panel__heading w-panel__heading--label">
                        <svg class="icon icon-lock w-panel__icon" aria-hidden="true"><use href="#icon-lock"></use></svg>
                        Verifica di sicurezza
                    </h2>
                </div>
                <div class="w-panel__content" style="background: var(--w-color-warning-50);">
                    <p class="w-help-text" style="margin: 0 0 1rem 0;">
                        Per confermare l'invio, risolvi questa operazione:
                    </p>
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <span style="font-size: 1.25rem; font-weight: 600;">
                            {{ num1 }} + {{ num2 }} =
                        </span>
                        <input type="hidden" name="expected_result" value="{{ expected_result }}">
                        <input type="number" name="captcha_result" required
                               class="w-field__input"
                               style="width: 80px; text-align: center; font-size: 1.25rem;"
                               placeholder="?">
                    </div>
                </div>
            </div>

            <!-- Pulsanti azione -->
            <div class="w-mb-4" style="margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: flex-end;">
                <a href="{% url 'wagtailsnippets_booking_appointment:edit' appointment.pk %}" 
                   class="button button-secondary">
                    Annulla
                </a>
                <button type="submit" class="button">
                    {% icon name="mail" %}
                    Invia Link
                </button>
            </div>
        </form>
    </div>
{% endblock %}
