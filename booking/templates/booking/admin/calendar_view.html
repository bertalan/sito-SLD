{% extends "wagtailadmin/base.html" %}
{% load wagtailadmin_tags %}

{% block titletag %}Calendario Studio{% endblock %}
{% block extra_css %}
{{ block.super }}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet">
<style>
    .calendar-container {
        background: var(--w-color-surface-page);
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 2rem;
    }
    
    .calendar-controls {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }
    
    .calendar-controls button {
        padding: 0.5rem 1rem;
        border: 1px solid var(--w-color-border-furniture);
        background: var(--w-color-surface-page);
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
    }
    
    .calendar-controls button:hover {
        background: var(--w-color-surface-header);
    }
    
    .calendar-controls button.active {
        background: var(--w-color-primary);
        color: white;
        border-color: var(--w-color-primary);
    }
    
    #calendar {
        min-height: 500px;
    }
    
    .fc .fc-toolbar-title {
        text-transform: capitalize;
    }
    
    .fc-event {
        cursor: pointer;
        font-size: 0.85rem;
    }
    
    /* WCAG 2.2 AA compliant colors (contrast ratio >= 4.5:1) */
    .fc-event-google {
        background-color: #1a56db !important;  /* Darker blue for better contrast */
        border-color: #1e429f !important;
        color: #ffffff !important;
    }
    
    .fc-event-booking {
        background-color: #057a55 !important;  /* Darker green for better contrast */
        border-color: #046c4e !important;
        color: #ffffff !important;
    }
    
    .fc-event-pending {
        background-color: #c27803 !important;  /* Darker amber */
        border-color: #9f580a !important;
        color: #ffffff !important;
    }
    
    .appointments-list {
        background: var(--w-color-surface-page);
        padding: 1.5rem;
        border-radius: 8px;
    }
    
    .appointments-list h3 {
        margin-top: 0;
        margin-bottom: 1rem;
        font-size: 1.1rem;
        color: var(--w-color-text-context);
    }
    
    .appointment-item {
        display: flex;
        align-items: center;
        padding: 0.75rem;
        border-bottom: 1px solid var(--w-color-border-furniture);
        gap: 1rem;
    }
    
    .appointment-item:last-child {
        border-bottom: none;
    }
    
    .appointment-date {
        min-width: 90px;
        font-weight: 600;
        color: var(--w-color-primary);
    }
    
    .appointment-time {
        min-width: 60px;
        color: var(--w-color-text-meta);
    }
    
    .appointment-title {
        flex: 1;
    }
    
    .appointment-type {
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    /* WCAG 2.2 AA compliant badge colors (contrast ratio >= 4.5:1) */
    .type-google {
        background: #1a56db;
        color: #ffffff;
    }
    
    .type-booking {
        background: #057a55;
        color: #ffffff;
    }
    
    .type-pending {
        background: #c27803;
        color: #ffffff;
    }
    
    .empty-state {
        text-align: center;
        padding: 2rem;
        color: var(--w-color-text-meta);
    }
    
    .legend {
        display: flex;
        gap: 1.5rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.85rem;
    }
    
    .legend-color {
        width: 12px;
        height: 12px;
        border-radius: 3px;
    }
    
    /* WCAG 2.2 AA compliant legend colors */
    .legend-google { background: #1a56db; }
    .legend-booking { background: #057a55; }
    .legend-pending { background: #c27803; }
    
    .sync-info {
        font-size: 0.8rem;
        color: var(--w-color-text-meta);
        margin-top: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
{% include "wagtailadmin/shared/header.html" with title="Calendario Studio" icon="calendar" %}

<div class="nice-padding">
    <div class="legend">
        <div class="legend-item">
            <span class="legend-color legend-google"></span>
            <span>Appuntamenti telefonici (Google)</span>
        </div>
        <div class="legend-item">
            <span class="legend-color legend-booking"></span>
            <span>Prenotazioni online (confermate)</span>
        </div>
        <div class="legend-item">
            <span class="legend-color legend-pending"></span>
            <span>Prenotazioni in attesa</span>
        </div>
    </div>
    
    <div class="calendar-container">
        <div class="calendar-controls">
            <button type="button" id="view-month" class="active">Mese</button>
            <button type="button" id="view-week">Settimana</button>
            <button type="button" id="view-day">Giorno</button>
        </div>
        <div id="calendar"></div>
        <p class="sync-info">
            {% if last_sync %}
                Ultimo aggiornamento Google Calendar: {{ last_sync|date:"d/m/Y H:i" }}
            {% else %}
                Google Calendar non ancora sincronizzato
            {% endif %}
        </p>
    </div>
    
    <div class="appointments-list">
        <h3>ðŸ“… Prossimi appuntamenti</h3>
        
        {% if upcoming_events %}
            {% for event in upcoming_events %}
            <div class="appointment-item">
                <span class="appointment-date">{{ event.date|date:"d/m/Y" }}</span>
                <span class="appointment-time">{{ event.time }}</span>
                <span class="appointment-title">{{ event.title }}</span>
                <span class="appointment-type type-{{ event.type }}">{{ event.type_label }}</span>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                Nessun appuntamento programmato
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.10/locales/it.global.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('calendar');
    
    const events = {{ calendar_events_json|safe }};
    
    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'it',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: ''
        },
        buttonText: {
            today: 'Oggi'
        },
        events: events,
        eventClassNames: function(arg) {
            return ['fc-event-' + arg.event.extendedProps.eventType];
        },
        eventClick: function(info) {
            if (info.event.url) {
                window.location.href = info.event.url;
            }
        },
        firstDay: 1, // LunedÃ¬
        fixedWeekCount: false,
        dayMaxEvents: 3,
        moreLinkText: 'altri'
    });
    
    calendar.render();
    
    // View buttons
    document.getElementById('view-month').addEventListener('click', function() {
        calendar.changeView('dayGridMonth');
        updateActiveButton(this);
    });
    
    document.getElementById('view-week').addEventListener('click', function() {
        calendar.changeView('timeGridWeek');
        updateActiveButton(this);
    });
    
    document.getElementById('view-day').addEventListener('click', function() {
        calendar.changeView('timeGridDay');
        updateActiveButton(this);
    });
    
    function updateActiveButton(activeBtn) {
        document.querySelectorAll('.calendar-controls button').forEach(btn => {
            btn.classList.remove('active');
        });
        activeBtn.classList.add('active');
    }
});
</script>
{% endblock %}
